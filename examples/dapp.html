<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YeYing Wallet Test DApp</title>
  <style>
    /* æ ·å¼ä¿æŒä¸å˜ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      transition: all 0.3s;
    }
    button:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .info {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }
    .result {
      background: #e8f5e9;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .error {
      background: #ffebee;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      color: #c62828;
    }
    .warning {
      background: #fff3e0;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      color: #e65100;
    }
    .section {
      margin: 30px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      max-width: 800px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª YeYing Wallet Test DApp</h1>

  <!-- é’±åŒ…æ£€æµ‹ -->
  <div class="section">
    <h2>é’±åŒ…æ£€æµ‹</h2>
    <div id="walletDetection" class="info">
      <p>æ­£åœ¨æ£€æµ‹é’±åŒ…...</p>
    </div>
  </div>

  <!-- è¿æ¥çŠ¶æ€ -->
  <div class="section">
    <h2>è¿æ¥çŠ¶æ€</h2>
    <div class="info">
      <p><strong>è¿æ¥çŠ¶æ€:</strong> <span id="connectionStatus">æœªè¿æ¥</span></p>
      <p><strong>è´¦æˆ·åœ°å€:</strong> <span id="accountAddress">-</span></p>
      <p><strong>é“¾ ID:</strong> <span id="chainId">-</span></p>
      <p><strong>ä½™é¢:</strong> <span id="balance">-</span></p>
    </div>
    <button onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    <button onclick="getAccounts()">è·å–è´¦æˆ·</button>
    <button onclick="getChainId()">è·å–é“¾ ID</button>
    <button onclick="getBalance()">è·å–ä½™é¢</button>
  </div>

  <!-- å‘é€äº¤æ˜“ -->
  <div class="section">
    <h2>å‘é€äº¤æ˜“</h2>
    <div>
      <label>æ¥æ”¶åœ°å€:</label>
      <input type="text" id="txTo" placeholder="0x..." value="0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb">
    </div>
    <div>
      <label>é‡‘é¢ (ETH):</label>
      <input type="text" id="txValue" placeholder="0.001" value="0.001">
    </div>
    <div>
      <label>æ•°æ® (å¯é€‰):</label>
      <input type="text" id="txData" placeholder="0x...">
    </div>
    <button onclick="sendTransaction()">å‘é€äº¤æ˜“</button>
  </div>
  <!-- ç­¾åæ¶ˆæ¯ -->
  <div class="section">
    <h2>ç­¾åæ¶ˆæ¯</h2>
    <div>
      <label>æ¶ˆæ¯å†…å®¹:</label>
      <textarea id="signMessage" rows="3" placeholder="è¾“å…¥è¦ç­¾åçš„æ¶ˆæ¯">Hello, YeYing Wallet!</textarea>
    </div>
    <button onclick="signMessage()">ç­¾åæ¶ˆæ¯</button>
  </div>

  <!-- ç»“æœæ˜¾ç¤º -->
  <div class="section">
    <h2>æ“ä½œç»“æœ</h2>
    <div id="result"></div>
  </div>

  <script>
    let currentAccount = null;
    let walletReady = false;

    // ç­‰å¾…é’±åŒ…æ³¨å…¥
    function waitForWallet() {
      return new Promise((resolve, reject) => {
        if (typeof window.ethereum !== 'undefined') {
          resolve(window.ethereum);
          return;
        }

        let attempts = 0;
        const maxAttempts = 50; // 5ç§’
        
        const interval = setInterval(() => {
          attempts++;

          if (typeof window.ethereum !== 'undefined') {
            clearInterval(interval);
            resolve(window.ethereum);
          } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            reject(new Error('æœªæ£€æµ‹åˆ°é’±åŒ…'));
          }
        }, 100);
      });
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æµ‹é’±åŒ…
    window.addEventListener('load', async () => {
      const detectionEl = document.getElementById('walletDetection');
      
      try {
        detectionEl.innerHTML = '<p>â³ æ­£åœ¨æ£€æµ‹é’±åŒ…...</p>';
        
        const ethereum = await waitForWallet();
        
        walletReady = true;
        
        // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
        let walletInfo = '<p>âœ… æ£€æµ‹åˆ°ä»¥å¤ªåŠé’±åŒ…</p>';

        if (ethereum.isYeYingWallet) {
          walletInfo += '<p>ğŸ‰ <strong>YeYing Wallet</strong> å·²å°±ç»ªï¼</p>';
        } else if (ethereum.isMetaMask) {
          walletInfo += '<p class="warning">âš ï¸ æ£€æµ‹åˆ° MetaMaskï¼Œå»ºè®®ç¦ç”¨åä½¿ç”¨ YeYing Wallet</p>';
        } else {
          walletInfo += '<p>â„¹ï¸ æ£€æµ‹åˆ°å…¶ä»–é’±åŒ…</p>';
        }
        
        detectionEl.innerHTML = walletInfo;
        detectionEl.className = 'result';

        // ç›‘å¬è´¦æˆ·å˜åŒ–
        ethereum.on('accountsChanged', (accounts) => {
          console.log('è´¦æˆ·å˜åŒ–:', accounts);
          if (accounts.length === 0) {
            currentAccount = null;
            updateConnectionStatus('å·²æ–­å¼€');
          } else {
            currentAccount = accounts[0];
            updateConnectionStatus('å·²è¿æ¥');
            getBalance();
          }
        });

        // ç›‘å¬é“¾å˜åŒ–
        ethereum.on('chainChanged', (chainId) => {
          console.log('é“¾å˜åŒ–:', chainId);
          document.getElementById('chainId').textContent = chainId;
          getBalance();
        });
        
        // ç›‘å¬æ–­å¼€è¿æ¥
        ethereum.on('disconnect', () => {
          console.log('é’±åŒ…æ–­å¼€è¿æ¥');
          currentAccount = null;
          updateConnectionStatus('å·²æ–­å¼€');
        });

      } catch (error) {
        console.error('é’±åŒ…æ£€æµ‹å¤±è´¥:', error);
        detectionEl.innerHTML = `
          <p>âŒ æœªæ£€æµ‹åˆ°é’±åŒ…</p>
          <p class="error">è¯·ç¡®ä¿ï¼š</p>
          <ul>
            <li>å·²å®‰è£… YeYing Wallet æ‰©å±•</li>
            <li>å·²å¯ç”¨æ‰©å±•</li>
            <li>å·²åœ¨æ‰©å±•è®¾ç½®ä¸­å…è®¸è®¿é—®æ–‡ä»¶ URLï¼ˆå¦‚æœä½¿ç”¨ file:// åè®®ï¼‰</li>
            <li>åˆ·æ–°é¡µé¢åé‡è¯•</li>
          </ul>
        `;
        detectionEl.className = 'error';
      }
    });

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(status) {
      document.getElementById('connectionStatus').textContent = status;
      if (currentAccount) {
        document.getElementById('accountAddress').textContent = currentAccount;
      } else {
        document.getElementById('accountAddress').textContent = '-';
        document.getElementById('balance').textContent = '-';
      }
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(message, isError = false) {
      const resultEl = document.getElementById('result');
      resultEl.className = isError ? 'error' : 'result';
      resultEl.textContent = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
      console.log(isError ? 'é”™è¯¯:' : 'ç»“æœ:', message);
    }

    // è¿æ¥é’±åŒ…
    async function connectWallet() {
      if (!walletReady) {
        showResult('é’±åŒ…æœªå°±ç»ªï¼Œè¯·ç­‰å¾…æ£€æµ‹å®Œæˆ', true);
        return;
      }
      
      try {
        showResult('æ­£åœ¨è¿æ¥é’±åŒ…...');
        
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });

        if (accounts.length > 0) {
          currentAccount = accounts[0];
          updateConnectionStatus('å·²è¿æ¥');
          showResult(`è¿æ¥æˆåŠŸï¼\nè´¦æˆ·: ${currentAccount}`);
          
          // è‡ªåŠ¨è·å–é“¾ ID å’Œä½™é¢
          await getChainId();
          await getBalance();
        } else {
          showResult('æœªè·å–åˆ°è´¦æˆ·', true);
        }
      } catch (error) {
        console.error('è¿æ¥å¤±è´¥:', error);
        showResult('è¿æ¥å¤±è´¥: ' + error.message, true);
      }
    }

    // è·å–è´¦æˆ·
    async function getAccounts() {
      if (!walletReady) {
        showResult('é’±åŒ…æœªå°±ç»ª', true);
        return;
      }

      try {
        const accounts = await window.ethereum.request({
          method: 'eth_accounts'
        });
        
        if (accounts.length > 0) {
          currentAccount = accounts[0];
          updateConnectionStatus('å·²è¿æ¥');
          showResult(`è´¦æˆ·åˆ—è¡¨:\n${accounts.join('\n')}`);
        } else {
          showResult('æœªè¿æ¥è´¦æˆ·ï¼Œè¯·å…ˆè¿æ¥é’±åŒ…', true);
        }
      } catch (error) {
        console.error('è·å–è´¦æˆ·å¤±è´¥:', error);
        showResult('è·å–è´¦æˆ·å¤±è´¥: ' + error.message, true);
      }
    }

    // è·å–é“¾ ID
    async function getChainId() {
      if (!walletReady) {
        showResult('é’±åŒ…æœªå°±ç»ª', true);
        return;
      }
      try {
        const chainId = await window.ethereum.request({
          method: 'eth_chainId'
        });
        
        document.getElementById('chainId').textContent = chainId;
        
        const chainNames = {
          '0x1': 'Ethereum Mainnet',
          '0xaa36a7': 'Sepolia Testnet',
          '0x5': 'Goerli Testnet',
          '0x1538': 'YeYing Network',
        };

        const chainName = chainNames[chainId] || 'æœªçŸ¥ç½‘ç»œ';
        showResult(`é“¾ ID: ${chainId}\nç½‘ç»œ: ${chainName}`);
      } catch (error) {
        console.error('è·å–é“¾ ID å¤±è´¥:', error);
        showResult('è·å–é“¾ ID å¤±è´¥: ' + error.message, true);
      }
    }

    // è·å–ä½™é¢
    async function getBalance() {
      if (!walletReady) {
        showResult('é’±åŒ…æœªå°±ç»ª', true);
        return;
      }
      
      if (!currentAccount) {
        showResult('è¯·å…ˆè¿æ¥é’±åŒ…', true);
        return;
      }

      try {
        const balance = await window.ethereum.request({
          method: 'eth_getBalance',
          params: [currentAccount, 'latest']
        });
        
        // è½¬æ¢ä¸º ETH
        const ethBalance = parseInt(balance, 16) / 1e18;
        document.getElementById('balance').textContent = ethBalance.toFixed(6) + ' ETH';
        
        showResult(`ä½™é¢: ${ethBalance.toFixed(6)} ETH\nåŸå§‹å€¼: ${balance}`);
      } catch (error) {
        console.error('è·å–ä½™é¢å¤±è´¥:', error);
        showResult('è·å–ä½™é¢å¤±è´¥: ' + error.message, true);
      }
    }

    // å‘é€äº¤æ˜“
    async function sendTransaction() {
      if (!walletReady) {
        showResult('é’±åŒ…æœªå°±ç»ª', true);
        return;
      }

      if (!currentAccount) {
        showResult('è¯·å…ˆè¿æ¥é’±åŒ…', true);
        return;
      }
      
      const to = document.getElementById('txTo').value;
      const value = document.getElementById('txValue').value;
      const data = document.getElementById('txData').value;
      
      if (!to) {
        showResult('è¯·è¾“å…¥æ¥æ”¶åœ°å€', true);
        return;
      }

      if (!value || parseFloat(value) <= 0) {
        showResult('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢', true);
        return;
      }

      try {
        showResult('æ­£åœ¨å‘é€äº¤æ˜“...');
        
        // è½¬æ¢é‡‘é¢ä¸º Wei
        const valueInWei = '0x' + (parseFloat(value) * 1e18).toString(16);
        
        const txParams = {
          from: currentAccount,
          to: to,
          value: valueInWei
        };
        
        if (data) {
          txParams.data = data;
        }
        
        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [txParams]
        });
        
        showResult(`äº¤æ˜“å·²å‘é€ï¼\näº¤æ˜“å“ˆå¸Œ: ${txHash}\n\nè¯·åœ¨é’±åŒ…ä¸­æŸ¥çœ‹äº¤æ˜“çŠ¶æ€`);
        
        // æ›´æ–°ä½™é¢
        setTimeout(() => getBalance(), 2000);
      } catch (error) {
        console.error('å‘é€äº¤æ˜“å¤±è´¥:', error);
        showResult('å‘é€äº¤æ˜“å¤±è´¥: ' + error.message, true);
      }
    }

    // ç­¾åæ¶ˆæ¯
    async function signMessage() {
      if (!walletReady) {
        showResult('é’±åŒ…æœªå°±ç»ª', true);
        return;
      }
      
      if (!currentAccount) {
        showResult('è¯·å…ˆè¿æ¥é’±åŒ…', true);
        return;
      }
      
      const message = document.getElementById('signMessage').value;
      
      if (!message) {
        showResult('è¯·è¾“å…¥è¦ç­¾åçš„æ¶ˆæ¯', true);
        return;
      }
      
      try {
        showResult('æ­£åœ¨ç­¾å...');
        
        const signature = await window.ethereum.request({
          method: 'personal_sign',
          params: [message, currentAccount]
        });

        showResult(`ç­¾åæˆåŠŸï¼\n\næ¶ˆæ¯: ${message}\n\nç­¾å: ${signature}`);
      } catch (error) {
        console.error('ç­¾åå¤±è´¥:', error);
        showResult('ç­¾åå¤±è´¥: ' + error.message, true);
      }
    }

    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + Enter è¿æ¥é’±åŒ…
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        connectWallet();
      }
    });
  </script>
</body>
</html>

