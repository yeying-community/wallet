<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YeYing Wallet - å®Œæ•´æµ‹è¯•</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap");

      :root {
        --ink: #1d2b2f;
        --muted: #5f6b6f;
        --paper: #ffffff;
        --card: #f7f2ea;
        --stroke: #e1ddd5;
        --accent: #0b7285;
        --accent-2: #f08c00;
        --success: #2b8a3e;
        --warn: #f59f00;
        --danger: #e03131;
        --info: #1971c2;
        --shadow: 0 18px 48px rgba(15, 23, 42, 0.18);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        font-family: "Space Grotesk", "IBM Plex Sans", "Segoe UI", sans-serif;
        background:
          radial-gradient(900px circle at 15% 10%, rgba(255, 255, 255, 0.9), transparent 55%),
          linear-gradient(120deg, #f2efe6 0%, #dfeef2 100%);
        min-height: 100vh;
        padding: 24px;
        color: var(--ink);
        overflow: hidden;
        overscroll-behavior: none;
      }

      .container {
        max-width: 980px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.96);
        border-radius: 20px;
        padding: 28px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(6px);
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .page-layout {
        display: grid;
        grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
        gap: 24px;
        align-items: start;
        height: 100%;
      }

      .page-layout .container {
        max-width: none;
        margin: 0;
        width: 100%;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      h1 {
        color: var(--ink);
        font-size: 20px;
        margin-top: 0;
      }

      .status {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid transparent;
        background: rgba(255, 255, 255, 0.7);
      }

      .status.connected {
        background: rgba(43, 138, 62, 0.12);
        color: var(--success);
        border-color: rgba(43, 138, 62, 0.3);
      }

      .status.disconnected {
        background: rgba(224, 49, 49, 0.12);
        color: var(--danger);
        border-color: rgba(224, 49, 49, 0.3);
      }

      .status.locked {
        background: rgba(245, 159, 0, 0.14);
        color: #8d5a00;
        border-color: rgba(245, 159, 0, 0.35);
      }

      .section {
        margin-bottom: 24px;
        padding: 20px;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--stroke);
      }

      .section h2 {
        font-size: 18px;
        margin-bottom: 15px;
        color: var(--ink);
      }

      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 8px;
      }

      button {
        padding: 11px 20px;
        border: none;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.15);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
      }

      .btn-secondary {
        background: var(--accent-2);
        color: white;
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-info {
        background: var(--info);
        color: white;
      }

      .btn-ghost {
        background: transparent;
        border: 1px dashed var(--stroke);
        color: var(--muted);
      }

      .btn-compact {
        padding: 6px 10px;
        font-size: 11px;
      }

      .tab-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 18px 0 6px;
      }

      .tab-btn {
        padding: 8px 14px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: #fff;
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .tab-btn.active {
        background: var(--accent);
        border-color: transparent;
        color: #fff;
        box-shadow: 0 6px 16px rgba(11, 114, 133, 0.25);
      }

      .tab-panel {
        display: none;
      }

      .tab-panel.active {
        display: block;
      }

      .tab-content {
        flex: 1;
        overflow-y: auto;
        padding-right: 6px;
        min-height: 0;
        overscroll-behavior: contain;
      }

      .info-box {
        background: var(--paper);
        padding: 14px;
        border-radius: 12px;
        margin-top: 14px;
        border: 1px solid var(--stroke);
        font-family: "JetBrains Mono", "Courier New", monospace;
        font-size: 12px;
        word-break: break-all;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 6px 0;
        border-bottom: 1px dashed var(--stroke);
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-row .label {
        color: var(--muted);
        min-width: 110px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 11px;
      }

      .info-row .value {
        text-align: right;
      }

      .form-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        margin-top: 12px;
      }

      .field label {
        display: block;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .field input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: #fff;
        font-family: "JetBrains Mono", "Courier New", monospace;
        font-size: 12px;
      }

      .note {
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
      }

      .log {
        background: #101415;
        color: #a7f3d0;
        padding: 15px;
        border-radius: 12px;
        flex: 1;
        overflow-y: auto;
        font-family: "JetBrains Mono", "Courier New", monospace;
        font-size: 12px;
        margin-top: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overscroll-behavior: contain;
      }

      .log-panel {
        align-self: stretch;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        min-height: 0;
        margin-bottom: 0;
      }

      .log-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .log-header .button-group {
        margin-top: 0;
      }

      @media (max-width: 1100px) {
        .page-layout {
          grid-template-columns: 1fr;
        }

        .log-panel {
          box-shadow: none;
        }
      }

      .footer {
        margin-top: 12px;
        font-size: 11px;
        color: var(--muted);
        text-align: center;
      }

      .log-entry {
        margin-bottom: 6px;
        padding: 6px 8px;
        border-left: 3px solid var(--accent);
        padding-left: 10px;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .log-entry.error {
        border-left-color: var(--danger);
        color: #fca5a5;
      }

      .log-entry.success {
        border-left-color: var(--success);
        color: #86efac;
      }
    </style>
  </head>

  <body>
    <div class="page-layout">
      <div class="container">
      <div class="header">
        <div>
          <h1>ğŸ¦… YeYing Wallet åŠŸèƒ½éªŒè¯å°</h1>
        </div>
        <div class="header-actions">
          <div id="status" class="status disconnected">æœªè¿æ¥</div>
        </div>
      </div>

      <div class="info-box" id="accountInfo" style="display: none">
        <div class="info-row">
          <span class="label">è´¦æˆ·</span>
          <span class="value" id="account">-</span>
        </div>
        <div class="info-row">
          <span class="label">é“¾ ID</span>
          <span class="value" id="chainId">-</span>
        </div>
        <div class="info-row">
          <span class="label">ç½‘ç»œ</span>
          <span class="value" id="networkName">-</span>
        </div>
        <div class="info-row">
          <span class="label">ä½™é¢</span>
          <span class="value" id="balance">-</span>
        </div>
        <div class="info-row">
          <span class="label">æƒé™</span>
          <span class="value" id="permissions">-</span>
        </div>
        <div class="info-row">
          <span class="label">é“¾/èŠ‚ç‚¹çš„è¿æ¥çŠ¶æ€</span>
          <span class="value" id="isConnected">-</span>
        </div>
      </div>

      <div class="tab-nav" role="tablist" aria-label="YeYing DApp Tabs">
        <button class="tab-btn active" data-tab="accounts" type="button">
          è¿æ¥ä¸è´¦æˆ·
        </button>
            <button class="tab-btn" data-tab="network" type="button">
              ç½‘ç»œç®¡ç†
            </button>
            <button class="tab-btn" data-tab="tx" type="button">äº¤æ˜“</button>
            <button class="tab-btn" data-tab="sign" type="button">ç­¾å</button>
            <button class="tab-btn" data-tab="token" type="button">
              ä»£å¸ç®¡ç†
            </button>
            <button class="tab-btn" data-tab="permissions" type="button">
              æƒé™ç®¡ç†
            </button>
        <button class="tab-btn" data-tab="events" type="button">
          äº‹ä»¶ç›‘å¬
        </button>
      </div>

      <div class="tab-content">
      <div class="tab-panel active" data-tab="accounts">
        <!-- 1. è¿æ¥æµ‹è¯• -->
        <div class="section">
          <div class="button-group">
            <button class="btn-primary" onclick="testConnect()">è¿æ¥é’±åŒ…</button>
            <button class="btn-secondary" onclick="testGetAccounts()">
              è·å–è´¦æˆ·
            </button>
            <button class="btn-info" onclick="testIsConnected()">
              æ£€æŸ¥è¿æ¥çŠ¶æ€
            </button>
            <button class="btn-danger" onclick="testDisconnect()">
              æ–­å¼€è¿æ¥
            </button>
          </div>
        </div>
      </div>

      <div class="tab-panel" data-tab="network">
        <!-- 2. ç½‘ç»œæµ‹è¯• -->
        <div class="section">
          <div class="button-group">
            <button class="btn-primary" onclick="testGetChainId()">
              è·å–é“¾ ID
            </button>
            <button class="btn-secondary" onclick="ensureYeYing()">
              åˆ‡æ¢/ç¡®ä¿ YeYing ä¸»ç½‘
            </button>
            <button class="btn-info" onclick="testSwitchCustomChain()">
              åˆ‡æ¢åˆ° Chain ID
            </button>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="customChainId">Chain ID (hex)</label>
              <input id="customChainId" value="0x1538" />
            </div>
            <div class="field">
              <label for="customChainName">Chain Name</label>
              <input id="customChainName" value="YeYing Mainnet" />
            </div>
            <div class="field">
              <label for="customRpcUrl">RPC URL</label>
              <input id="customRpcUrl" value="https://blockchain.yeying.pub" />
            </div>
            <div class="field">
              <label for="customSymbol">Symbol</label>
              <input id="customSymbol" value="YYT" />
            </div>
            <div class="field">
              <label for="customExplorer">Explorer URL</label>
              <input id="customExplorer" value="https://blockscout.yeying.pub" />
            </div>
          </div>

          <div class="button-group">
            <button class="btn-primary" onclick="testAddCustomChain()">
              æ·»åŠ è‡ªå®šä¹‰ç½‘ç»œ
            </button>
            <button class="btn-ghost" onclick="fillChainPreset('yeying')">
              é¢„è®¾ï¼šYeYing
            </button>
            <button class="btn-ghost" onclick="fillChainPreset('ethereum')">
              é¢„è®¾ï¼šEthereum
            </button>
            <button class="btn-ghost" onclick="fillChainPreset('sepolia')">
              é¢„è®¾ï¼šSepolia
            </button>
          </div>
          <div class="note">
            é»˜è®¤æ”¯æŒ YeYing ä¸»ç½‘ï¼›å…¶å®ƒç½‘ç»œéœ€é€šè¿‡â€œæ·»åŠ è‡ªå®šä¹‰ç½‘ç»œâ€å®Œæˆæ³¨å†Œã€‚
          </div>
        </div>
      </div>

      <div class="tab-panel" data-tab="tx">
        <!-- 3. äº¤æ˜“æµ‹è¯• -->
        <div class="section">
          <div class="button-group">
            <button class="btn-primary" onclick="testSendTransaction()">
              å‘é€ 0.001 åŸç”Ÿå¸
            </button>
            <button class="btn-secondary" onclick="testSendWithData()">
              å‘é€å¸¦æ•°æ®çš„äº¤æ˜“
            </button>
          </div>
          <div class="note">
            äº¤æ˜“ä¼šçœŸå®å¹¿æ’­åˆ°å½“å‰é“¾ï¼Œè¯·ç¡®ä¿è´¦æˆ·æœ‰ä½™é¢ä¸”æ”¶æ¬¾åœ°å€æ­£ç¡®ã€‚
          </div>
        </div>
      </div>

      <div class="tab-panel" data-tab="sign">
        <!-- 4. ç­¾åæµ‹è¯• -->
        <div class="section">
          <div class="button-group">
            <button class="btn-primary" onclick="testPersonalSign()">
              ä¸ªäººç­¾å
            </button>
            <button class="btn-secondary" onclick="testSignTypedData()">
              TypedData ç­¾å
            </button>
          </div>
        </div>
      </div>

      <div class="tab-panel" data-tab="token">
        <!-- 5. ä»£å¸æµ‹è¯• -->
        <div class="section">
          <div class="form-grid">
            <div class="field">
              <label for="tokenAddress">Token Address</label>
              <input id="tokenAddress" placeholder="0x..." />
            </div>
            <div class="field">
              <label for="tokenSymbol">Token Symbol</label>
              <input id="tokenSymbol" placeholder="YYT" />
            </div>
            <div class="field">
              <label for="tokenDecimals">Decimals</label>
              <input id="tokenDecimals" value="18" />
            </div>
            <div class="field">
              <label for="tokenImage">Token Image URL</label>
              <input id="tokenImage" placeholder="https://..." />
            </div>
          </div>
          <div class="button-group">
            <button class="btn-primary" onclick="testWatchCustomToken()">
              æ·»åŠ è‡ªå®šä¹‰ä»£å¸
            </button>
            <button class="btn-ghost" onclick="fillTokenPreset('usdc')">
              é¢„è®¾ USDC (ETH ä¸»ç½‘)
            </button>
            <button class="btn-ghost" onclick="fillTokenPreset('dai')">
              é¢„è®¾ DAI (ETH ä¸»ç½‘)
            </button>
          </div>
          <div class="note">
            ä¸»ç½‘ä»£å¸ç¤ºä¾‹ä»…ç”¨äºéªŒè¯æµç¨‹ï¼Œéœ€ç¡®ä¿å½“å‰é“¾æ”¯æŒå¯¹åº”èµ„äº§ã€‚
          </div>
        </div>
      </div>

      <div class="tab-panel" data-tab="permissions">
        <!-- 6. æƒé™æµ‹è¯• -->
        <div class="section">
          <div class="button-group">
            <button class="btn-primary" onclick="testGetPermissions()">
              è·å–æƒé™
            </button>
            <button class="btn-secondary" onclick="testRequestPermissions()">
              è¯·æ±‚æƒé™
            </button>
            <button class="btn-danger" onclick="testRevokePermissions()">
              æ’¤é”€æƒé™
            </button>
          </div>
        </div>
      </div>

      <div class="tab-panel" data-tab="events">
        <!-- 7. äº‹ä»¶æµ‹è¯• -->
        <div class="section">
          <div class="button-group">
            <button class="btn-primary" onclick="testListenEvents()">
              å¼€å§‹ç›‘å¬äº‹ä»¶
            </button>
            <button class="btn-danger" onclick="testRemoveListeners()">
              ç§»é™¤ç›‘å¬
            </button>
          </div>
        </div>
      </div>
      </div>
      <div class="footer">YeYing Wallet Test Console Â· DApp åŠŸèƒ½éªŒè¯</div>
    </div>
    <div class="section log-panel">
      <div class="log-header">
        <h2>ğŸ§¾ æµ‹è¯•æ—¥å¿—</h2>
        <div class="button-group">
          <button class="btn-ghost btn-compact" onclick="refreshDiagnostics()">
            åˆ·æ–°è¯Šæ–­
          </button>
          <button class="btn-danger btn-compact" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
      </div>
      <div class="log" id="log">
        <div class="log-entry">ğŸ“‹ æµ‹è¯•æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
      </div>
    </div>
  </div>

    <script>
      let walletProvider = null;
      let providerPromise = null;
      let currentAccount = null;
      let eventListeners = {};
      let lastKnownChainId = null;
      const LOG_LIMIT = 200;

      const CHAIN_PRESETS = {
        yeying: {
          chainId: "0x1538",
          chainName: "YeYing Mainnet",
          rpcUrls: ["https://blockchain.yeying.pub"],
          nativeCurrency: { name: "YeYing", symbol: "YYT", decimals: 18 },
          blockExplorerUrls: ["https://blockscout.yeying.pub"],
        },
        ethereum: {
          chainId: "0x1",
          chainName: "Ethereum Mainnet",
          rpcUrls: ["https://cloudflare-eth.com"],
          nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
          blockExplorerUrls: ["https://etherscan.io"],
        },
        sepolia: {
          chainId: "0xaa36a7",
          chainName: "Sepolia",
          rpcUrls: ["https://rpc.sepolia.org"],
          nativeCurrency: { name: "SepoliaETH", symbol: "ETH", decimals: 18 },
          blockExplorerUrls: ["https://sepolia.etherscan.io"],
        },
      };

      const TOKEN_PRESETS = {
        usdc: {
          address: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
          symbol: "USDC",
          decimals: 6,
          image: "https://cryptologos.cc/logos/usd-coin-usdc-logo.png",
        },
        dai: {
          address: "0x6B175474E89094C44Da98b954EedeAC495271d0F",
          symbol: "DAI",
          decimals: 18,
          image: "https://cryptologos.cc/logos/multi-collateral-dai-dai-logo.png",
        },
      };

      function waitForEthereum(timeout = 3000) {
        if (window.ethereum) {
          walletProvider = window.ethereum;
          return Promise.resolve(walletProvider);
        }

        if (!providerPromise) {
          providerPromise = new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
              reject(new Error("æœªæ£€æµ‹åˆ°é’±åŒ… Provider"));
            }, timeout);

            const handler = () => {
              if (window.ethereum) {
                walletProvider = window.ethereum;
                clearTimeout(timer);
                resolve(walletProvider);
              }
            };

            window.addEventListener("ethereum#initialized", handler, { once: true });
          });
        }

        return providerPromise;
      }

      // æ—¥å¿—å‡½æ•°
      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        while (logDiv.children.length > LOG_LIMIT) {
          logDiv.removeChild(logDiv.firstChild);
        }
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        const logDiv = document.getElementById("log");
        logDiv.innerHTML = "<div class=\"log-entry\">ğŸ“‹ æ—¥å¿—å·²æ¸…ç©º</div>";
      }

      function setActiveTab(tabId) {
        const buttons = document.querySelectorAll(".tab-btn");
        const panels = document.querySelectorAll(".tab-panel");
        buttons.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.tab === tabId);
        });
        panels.forEach((panel) => {
          panel.classList.toggle("active", panel.dataset.tab === tabId);
        });
      }

      function getChainLabel(chainId) {
        if (!chainId) return "-";
        const normalized = String(chainId).toLowerCase();
        const preset = Object.values(CHAIN_PRESETS).find(
          (item) => item.chainId.toLowerCase() === normalized
        );
        if (preset) {
          const symbol = preset.nativeCurrency?.symbol || "-";
          return `${preset.chainName} (${symbol})`;
        }
        return `æœªçŸ¥ç½‘ç»œ (${chainId})`;
      }

      function getChainSymbol(chainId) {
        if (!chainId) return "NATIVE";
        const normalized = String(chainId).toLowerCase();
        const preset = Object.values(CHAIN_PRESETS).find(
          (item) => item.chainId.toLowerCase() === normalized
        );
        return preset?.nativeCurrency?.symbol || "NATIVE";
      }

      function base64UrlEncode(text) {
        const base64 = btoa(text);
        return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      }

      function buildSiweMessage({
        domain,
        address,
        uri,
        chainId,
        statement,
        resources = [],
      }) {
        const nonce = Math.random().toString(36).slice(2, 10);
        const issuedAt = new Date().toISOString();
        const lines = [];
        lines.push(`${domain} wants you to sign in with your Ethereum account:`);
        lines.push(address);
        lines.push("");
        if (statement) {
          lines.push(statement);
          lines.push("");
        }
        lines.push(`URI: ${uri}`);
        lines.push("Version: 1");
        lines.push(`Chain ID: ${chainId}`);
        lines.push(`Nonce: ${nonce}`);
        lines.push(`Issued At: ${issuedAt}`);
        if (resources.length) {
          lines.push("Resources:");
          resources.forEach((resource) => {
            lines.push(`- ${resource}`);
          });
        }
        return lines.join("\n");
      }

      function setPermissionStatus(hasPermission) {
        const el = document.getElementById("permissions");
        if (!el) return;
        if (hasPermission === true) {
          el.textContent = "å·²æˆæƒ";
        } else if (hasPermission === false) {
          el.textContent = "æœªæˆæƒ";
        } else {
          el.textContent = "-";
        }
      }

      // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
      function setStatus(status, account = null, chainId = null, permissionState = null) {
        const statusDiv = document.getElementById("status");
        const accountInfo = document.getElementById("accountInfo");
        const connectedFlag =
          walletProvider && walletProvider.isConnected
            ? walletProvider.isConnected()
            : false;

        if (status === "connected" && account) {
          statusDiv.className = "status connected";
          statusDiv.textContent = `âœ… å·²è¿æ¥: ${account.substring(
            0,
            6
          )}...${account.substring(38)}`;
          accountInfo.style.display = "block";
          document.getElementById("account").textContent = account;
          document.getElementById("chainId").textContent = chainId || "-";
          document.getElementById("networkName").textContent =
            getChainLabel(chainId);
          document.getElementById("isConnected").textContent =
            connectedFlag ? "âœ… æ˜¯" : "âŒ å¦";
          setPermissionStatus(permissionState ?? true);
          currentAccount = account;
          updateBalance(account);
        } else if (status === "locked") {
          statusDiv.className = "status locked";
          statusDiv.textContent = "ğŸ”’ é’±åŒ…å·²é”å®šï¼ˆå·²æˆæƒï¼‰";
          accountInfo.style.display = "block";
          document.getElementById("account").textContent = "å·²é”å®š";
          document.getElementById("chainId").textContent = chainId || "-";
          document.getElementById("networkName").textContent =
            getChainLabel(chainId);
          document.getElementById("balance").textContent = "-";
          document.getElementById("isConnected").textContent =
            connectedFlag ? "âœ… æ˜¯" : "âŒ å¦";
          setPermissionStatus(permissionState ?? true);
          currentAccount = null;
        } else {
          statusDiv.className = "status disconnected";
          statusDiv.textContent = "âŒ æœªè¿æ¥";
          accountInfo.style.display = "block";
          document.getElementById("account").textContent = "-";
          const chainToShow =
            chainId || lastKnownChainId || walletProvider?.chainId || null;
          document.getElementById("chainId").textContent = chainToShow || "-";
          document.getElementById("networkName").textContent = chainToShow
            ? getChainLabel(chainToShow)
            : "-";
          document.getElementById("balance").textContent = "-";
          document.getElementById("isConnected").textContent = "âŒ å¦";
          setPermissionStatus(permissionState);
          currentAccount = null;
        }
      }

      function updateStatus(connected, account = null, chainId = null, permissionState = null) {
        if (chainId) {
          lastKnownChainId = chainId;
        }
        if (
          connected === "connected" ||
          connected === "locked" ||
          connected === "disconnected"
        ) {
          setStatus(connected, account, chainId, permissionState);
          return;
        }
        setStatus(
          connected ? "connected" : "disconnected",
          account,
          chainId,
          permissionState
        );
      }

      async function resolveEmptyAccountsState(provider, accounts, permissions) {
        let accountList = Array.isArray(accounts) ? accounts : null;
        let permissionList = Array.isArray(permissions) ? permissions : null;

        if (!accountList) {
          try {
            accountList = await provider.request({ method: "eth_accounts" });
          } catch (error) {
            accountList = [];
          }
        }

        if (!permissionList) {
          try {
            permissionList = await provider.request({
              method: "wallet_getPermissions",
            });
          } catch (error) {
            permissionList = [];
          }
        }

        const hasEthAccounts = Array.isArray(permissionList)
          ? permissionList.some(
              (perm) => perm && perm.parentCapability === "eth_accounts"
            )
          : false;

        if (accountList.length > 0) {
          return { status: "connected", hasPermission: true };
        }

        if (hasEthAccounts) {
          return { status: "locked", hasPermission: true };
        }

        return {
          status: "disconnected",
          hasPermission: false,
        };
      }

      async function refreshDiagnostics() {
        try {
          const provider = await waitForEthereum();
          const [accounts, chainId, permissions] = await Promise.all([
            provider.request({ method: "eth_accounts" }).catch(() => []),
            provider.request({ method: "eth_chainId" }).catch(() => null),
            provider.request({ method: "wallet_getPermissions" }).catch(() => []),
          ]);
          if (chainId) {
            lastKnownChainId = chainId;
          }
          const state = await resolveEmptyAccountsState(
            provider,
            accounts,
            permissions
          );

          const report = {
            provider: {
              isYeYing: Boolean(provider?.isYeYing),
              isMetaMask: Boolean(provider?.isMetaMask),
              isConnected: provider?.isConnected ? provider.isConnected() : false,
              selectedAddress: provider?.selectedAddress || null,
            },
            chainId,
            network: getChainLabel(chainId),
            accounts,
            permissions,
            connectState: state.status,
          };

          setPermissionStatus(state.hasPermission);
          const diagnosticsText = JSON.stringify(report, null, 2);
          log(`ğŸ§ª è¯Šæ–­ä¿¡æ¯\n${diagnosticsText}`);
        } catch (error) {
          log(`âŒ è¯Šæ–­å¤±è´¥: ${error.message}`, "error");
        }
      }
      // æ›´æ–°ä½™é¢
      async function updateBalance(account) {
        try {
          const provider = await waitForEthereum();
          const balance = await provider.request({
            method: "eth_getBalance",
            params: [account, "latest"],
          });
          const chainId = await provider
            .request({ method: "eth_chainId" })
            .catch(() => null);
          if (chainId) {
            lastKnownChainId = chainId;
          }
          const symbol = getChainSymbol(chainId);
          const ethBalance = parseInt(balance, 16) / 1e18;
          document.getElementById("balance").textContent =
            ethBalance.toFixed(4) + " " + symbol;
        } catch (error) {
          document.getElementById("balance").textContent = "è·å–å¤±è´¥";
        }
      }

      // ========== 1. è¿æ¥æµ‹è¯• ==========
      async function testConnect() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ è¯·æ±‚è¿æ¥é’±åŒ…...");
          const accounts = await provider.request({
            method: "eth_requestAccounts",
          });
          const chainId = await provider.request({ method: "eth_chainId" });
          log(`âœ… è¿æ¥æˆåŠŸ! è´¦æˆ·: ${accounts[0]}`, "success");
          updateStatus("connected", accounts[0], chainId, true);
          refreshDiagnostics();
        } catch (error) {
          log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testGetAccounts() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ è·å–è´¦æˆ·åˆ—è¡¨...");
          const accounts = await provider.request({ method: "eth_accounts" });
          if (accounts.length > 0) {
            log(`âœ… è´¦æˆ·: ${accounts[0]}`, "success");
            const chainId = await provider.request({ method: "eth_chainId" });
            updateStatus("connected", accounts[0], chainId, true);
            refreshDiagnostics();
          } else {
            const emptyState = await resolveEmptyAccountsState(provider, accounts);
            let chainId = null;
            if (emptyState.status === "locked") {
              try {
                chainId = await provider.request({ method: "eth_chainId" });
              } catch (error) {
                chainId = null;
              }
              log("ğŸ”’ é’±åŒ…å·²æˆæƒä½†å¤„äºé”å®šçŠ¶æ€", "info");
            } else {
              log("âš ï¸ æœªæˆæƒï¼Œè¯·å…ˆè¿æ¥é’±åŒ…");
            }
            updateStatus(
              emptyState.status,
              null,
              chainId,
              emptyState.hasPermission
            );
          }
        } catch (error) {
          log(`âŒ è·å–è´¦æˆ·å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testIsConnected() {
        try {
          const provider = await waitForEthereum();
          const connected = provider.isConnected();
          log(`ğŸ”µ è¿æ¥çŠ¶æ€: ${connected ? "âœ… å·²è¿æ¥" : "âŒ æœªè¿æ¥"}`);
        } catch (error) {
          log(`âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testDisconnect() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ æ’¤é”€æƒé™...");
          await provider.request({
            method: "wallet_revokePermissions",
            params: [{ eth_accounts: {} }],
          });
          const accounts = await provider
            .request({ method: "eth_accounts" })
            .catch(() => []);
          const state = await resolveEmptyAccountsState(provider, accounts);
          let chainId = null;
          if (state.status === "locked") {
            try {
              chainId = await provider.request({ method: "eth_chainId" });
            } catch (error) {
              chainId = null;
            }
          }
          if (state.status === "disconnected") {
            log("âœ… å·²æ–­å¼€è¿æ¥", "success");
          } else {
            log("âš ï¸ æƒé™ä»å­˜åœ¨ï¼Œå¯èƒ½æœªæ’¤é”€", "error");
          }
          updateStatus(state.status, null, chainId, state.hasPermission);
          refreshDiagnostics();
        } catch (error) {
          log(`âŒ æ–­å¼€å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ========== 2. ç½‘ç»œæµ‹è¯• ==========
      function fillChainPreset(key) {
        const preset = CHAIN_PRESETS[key];
        if (!preset) return;

        document.getElementById("customChainId").value = preset.chainId;
        document.getElementById("customChainName").value = preset.chainName;
        document.getElementById("customRpcUrl").value = preset.rpcUrls?.[0] || "";
        document.getElementById("customSymbol").value =
          preset.nativeCurrency?.symbol || "";
        document.getElementById("customExplorer").value =
          preset.blockExplorerUrls?.[0] || "";
      }

      function getCustomChainConfig() {
        const chainId = document.getElementById("customChainId").value.trim();
        const chainName = document.getElementById("customChainName").value.trim();
        const rpcUrl = document.getElementById("customRpcUrl").value.trim();
        const symbol = document.getElementById("customSymbol").value.trim();
        const explorer = document.getElementById("customExplorer").value.trim();

        return {
          chainId,
          chainName,
          rpcUrls: [rpcUrl],
          nativeCurrency: {
            name: chainName || symbol || "Native",
            symbol: symbol || "NATIVE",
            decimals: 18,
          },
          blockExplorerUrls: explorer ? [explorer] : [],
        };
      }

      async function testGetChainId() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ è·å–é“¾ ID...");
          const chainId = await provider.request({ method: "eth_chainId" });
          if (chainId) {
            lastKnownChainId = chainId;
          }
          log(
            `âœ… å½“å‰é“¾: ${chainId} (${parseInt(chainId, 16)}) ${getChainLabel(
              chainId
            )}`,
            "success"
          );
        } catch (error) {
          log(`âŒ è·å–å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function switchOrAddChain(provider, chainConfig) {
        try {
          await provider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: chainConfig.chainId }],
          });
          return "switched";
        } catch (error) {
          const message = String(error?.message || "");
          if (error?.code === 4902 || /unrecognized|not found/i.test(message)) {
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [chainConfig],
            });
            return "added";
          }
          throw error;
        }
      }

      async function ensureYeYing() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ åˆ‡æ¢/ç¡®ä¿ YeYing ä¸»ç½‘...");
          const result = await switchOrAddChain(provider, CHAIN_PRESETS.yeying);
          log(
            result === "added"
              ? "âœ… å·²æ·»åŠ å¹¶åˆ‡æ¢åˆ° YeYing ä¸»ç½‘"
              : "âœ… å·²åˆ‡æ¢åˆ° YeYing ä¸»ç½‘",
            "success"
          );
        } catch (error) {
          log(`âŒ åˆ‡æ¢å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testAddCustomChain() {
        try {
          const provider = await waitForEthereum();
          const chainConfig = getCustomChainConfig();
          log(`ğŸ”µ æ·»åŠ ç½‘ç»œ: ${chainConfig.chainName}...`);
          await provider.request({
            method: "wallet_addEthereumChain",
            params: [chainConfig],
          });
          log("âœ… ç½‘ç»œæ·»åŠ æˆåŠŸ!", "success");
        } catch (error) {
          log(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testSwitchCustomChain() {
        try {
          const provider = await waitForEthereum();
          const chainConfig = getCustomChainConfig();
          log(`ğŸ”µ åˆ‡æ¢åˆ°é“¾ ${chainConfig.chainId}...`);
          await provider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: chainConfig.chainId }],
          });
          log("âœ… åˆ‡æ¢æˆåŠŸ!", "success");
        } catch (error) {
          log(`âŒ åˆ‡æ¢å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ========== 3. äº¤æ˜“æµ‹è¯• ==========
      async function testSendTransaction() {
        if (!currentAccount) {
          log("âš ï¸ è¯·å…ˆè¿æ¥é’±åŒ…");
          return;
        }

        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ å‘é€ 0.001 åŸç”Ÿå¸...");
          const txHash = await provider.request({
            method: "eth_sendTransaction",
            params: [
              {
                from: currentAccount,
                to: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
                value: "0x38D7EA4C68000", // 0.001 native
                gas: "0x5208",
              },
            ],
          });
          log(`âœ… äº¤æ˜“å·²å‘é€! Hash: ${txHash}`, "success");
        } catch (error) {
          log(`âŒ äº¤æ˜“å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testSendWithData() {
        if (!currentAccount) {
          log("âš ï¸ è¯·å…ˆè¿æ¥é’±åŒ…");
          return;
        }

        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ å‘é€å¸¦æ•°æ®çš„äº¤æ˜“...");
          const txHash = await provider.request({
            method: "eth_sendTransaction",
            params: [
              {
                from: currentAccount,
                to: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
                value: "0x0",
                data: "0x48656c6c6f20576f726c6421", // "Hello World!"
              },
            ],
          });
          log(`âœ… äº¤æ˜“å·²å‘é€! Hash: ${txHash}`, "success");
        } catch (error) {
          log(`âŒ äº¤æ˜“å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ========== 4. ç­¾åæµ‹è¯• ==========
      async function testPersonalSign() {
        if (!currentAccount) {
          log("âš ï¸ è¯·å…ˆè¿æ¥é’±åŒ…");
          return;
        }

        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ è¯·æ±‚ä¸ªäººç­¾å...");
          const chainIdHex = await provider.request({ method: "eth_chainId" });
          const chainId = parseInt(chainIdHex, 16);
          const origin = window.location.origin || "https://example.org";
          const recap = {
            att: {
              [origin]: {
                "read:profile": [{}],
                "write:profile": [{ limit: 1 }],
              },
              "yeying:tx": {
                "sign:transaction": [{}],
              },
            },
          };
          const recapResource = `urn:recap:${base64UrlEncode(
            JSON.stringify(recap)
          )}`;
          const message = buildSiweMessage({
            domain: window.location.host || "example.org",
            address: currentAccount,
            uri: origin,
            chainId,
            statement: "Sign in to YeYing Wallet Test.",
            resources: [
              "https://login.xyz",
              "https://docs.login.xyz",
              recapResource,
            ],
          });
          const signature = await provider.request({
            method: "personal_sign",
            params: [message, currentAccount],
          });
          log(
            `âœ… ç­¾åæˆåŠŸ! Signature: ${signature.substring(0, 20)}...`,
            "success"
          );
        } catch (error) {
          log(`âŒ ç­¾åå¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testSignTypedData() {
        if (!currentAccount) {
          log("âš ï¸ è¯·å…ˆè¿æ¥é’±åŒ…");
          return;
        }

        try {
          const provider = await waitForEthereum();
          const chainIdHex = await provider.request({ method: "eth_chainId" });
          const chainId = parseInt(chainIdHex, 16);

          log("ğŸ”µ è¯·æ±‚ TypedData ç­¾å...");
          const msgParams = {
            domain: {
              name: "TestToken",
              version: "1",
              chainId: chainId,
              verifyingContract: "0x0000000000000000000000000000000000000001",
            },
            primaryType: "Permit",
            types: {
              EIP712Domain: [
                { name: "name", type: "string" },
                { name: "version", type: "string" },
                { name: "chainId", type: "uint256" },
                { name: "verifyingContract", type: "address" },
              ],
              Permit: [
                { name: "owner", type: "address" },
                { name: "spender", type: "address" },
                { name: "value", type: "uint256" },
                { name: "nonce", type: "uint256" },
                { name: "deadline", type: "uint256" },
              ],
            },
            message: {
              owner: currentAccount,
              spender: "0x0000000000000000000000000000000000000002",
              value: "1000000000000000000",
              nonce: 0,
              deadline: 4102444800,
            },
          };

          const signature = await provider.request({
            method: "eth_signTypedData_v4",
            params: [currentAccount, JSON.stringify(msgParams)],
          });

          log(
            `âœ… TypedData ç­¾åæˆåŠŸ! Signature: ${signature.substring(
              0,
              20
            )}...`,
            "success"
          );
        } catch (error) {
          log(`âŒ ç­¾åå¤±è´¥: ${error.message}`, "error");
        }
      }

      // ========== 5. ä»£å¸æµ‹è¯• ==========
      function fillTokenPreset(key) {
        const preset = TOKEN_PRESETS[key];
        if (!preset) return;
        document.getElementById("tokenAddress").value = preset.address;
        document.getElementById("tokenSymbol").value = preset.symbol;
        document.getElementById("tokenDecimals").value = String(
          preset.decimals ?? 18
        );
        document.getElementById("tokenImage").value = preset.image || "";
      }

      async function testWatchCustomToken() {
        try {
          const provider = await waitForEthereum();
          const address = document.getElementById("tokenAddress").value.trim();
          const symbol = document.getElementById("tokenSymbol").value.trim();
          const decimals = parseInt(
            document.getElementById("tokenDecimals").value.trim() || "18",
            10
          );
          const image = document.getElementById("tokenImage").value.trim();

          if (!address || !symbol) {
            log("âš ï¸ è¯·è¾“å…¥ä»£å¸åœ°å€ä¸ç¬¦å·", "error");
            return;
          }

          log(`ğŸ”µ æ·»åŠ ä»£å¸: ${symbol}...`);
          const result = await provider.request({
            method: "wallet_watchAsset",
            params: {
              type: "ERC20",
              options: {
                address,
                symbol,
                decimals: Number.isFinite(decimals) ? decimals : 18,
                image: image || undefined,
              },
            },
          });
          log(
            result ? "âœ… ä»£å¸æ·»åŠ æˆåŠŸ!" : "âš ï¸ ç”¨æˆ·å–æ¶ˆ",
            result ? "success" : "info"
          );
        } catch (error) {
          log(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ========== 6. æƒé™æµ‹è¯• ==========
      async function testGetPermissions() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ è·å–æƒé™åˆ—è¡¨...");
          const permissions = await provider.request({
            method: "wallet_getPermissions",
          });
          const hasAccounts = Array.isArray(permissions)
            ? permissions.some(
                (perm) => perm && perm.parentCapability === "eth_accounts"
              )
            : false;
          setPermissionStatus(hasAccounts);
          log(`âœ… æƒé™: ${JSON.stringify(permissions, null, 2)}`, "success");
        } catch (error) {
          log(`âŒ è·å–å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testRequestPermissions() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ è¯·æ±‚æƒé™...");
          const permissions = await provider.request({
            method: "wallet_requestPermissions",
            params: [{ eth_accounts: {} }],
          });
          setPermissionStatus(true);
          log(
            `âœ… æƒé™å·²æˆäºˆ: ${JSON.stringify(permissions, null, 2)}`,
            "success"
          );
        } catch (error) {
          log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, "error");
        }
      }

      async function testRevokePermissions() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ æ’¤é”€æƒé™...");
          await provider.request({
            method: "wallet_revokePermissions",
            params: [{ eth_accounts: {} }],
          });
          log("âœ… æƒé™å·²æ’¤é”€", "success");
          setPermissionStatus(false);
          updateStatus("disconnected", null, null, false);
        } catch (error) {
          log(`âŒ æ’¤é”€å¤±è´¥: ${error.message}`, "error");
        }
      }

      // ========== 7. äº‹ä»¶æµ‹è¯• ==========
      async function testListenEvents() {
        try {
          const provider = await waitForEthereum();
          log("ğŸ”µ å¼€å§‹ç›‘å¬äº‹ä»¶...");

          // connect äº‹ä»¶
          eventListeners.connect = (connectInfo) => {
            log(`ğŸ“¢ connect äº‹ä»¶: chainId=${connectInfo.chainId}`, "success");
          };
          provider.on("connect", eventListeners.connect);

          // disconnect äº‹ä»¶
          eventListeners.disconnect = (error) => {
            log(`ğŸ“¢ disconnect äº‹ä»¶: ${error.message}`, "error");
            updateStatus("disconnected", null, null, false);
          };
          provider.on("disconnect", eventListeners.disconnect);

          // accountsChanged äº‹ä»¶
          eventListeners.accountsChanged = (accounts) => {
            log(`ğŸ“¢ accountsChanged äº‹ä»¶: ${accounts[0] || "æ— è´¦æˆ·"}`, "success");
            if (accounts.length > 0) {
              provider.request({ method: "eth_chainId" }).then((chainId) => {
                updateStatus("connected", accounts[0], chainId, true);
              });
            } else {
              resolveEmptyAccountsState(provider, accounts).then(async (state) => {
                let chainId = null;
                if (state.status === "locked") {
                  try {
                    chainId = await provider.request({ method: "eth_chainId" });
                  } catch (error) {
                    chainId = null;
                  }
                }
                updateStatus(state.status, null, chainId, state.hasPermission);
              });
            }
          };
          provider.on("accountsChanged", eventListeners.accountsChanged);

          // chainChanged äº‹ä»¶
          eventListeners.chainChanged = (chainId) => {
            log(
              `ğŸ“¢ chainChanged äº‹ä»¶: ${chainId} (${parseInt(chainId, 16)})`,
              "success"
            );
            if (currentAccount) {
              updateStatus("connected", currentAccount, chainId, true);
            }
          };
          provider.on("chainChanged", eventListeners.chainChanged);

          log("âœ… äº‹ä»¶ç›‘å¬å·²å¯åŠ¨", "success");
        } catch (error) {
          log(`âŒ ç›‘å¬å¤±è´¥: ${error.message}`, "error");
        }
      }

      function testRemoveListeners() {
        log("ğŸ”µ ç§»é™¤äº‹ä»¶ç›‘å¬...");

        if (walletProvider) {
          if (eventListeners.connect) {
            walletProvider.removeListener("connect", eventListeners.connect);
          }
          if (eventListeners.disconnect) {
            walletProvider.removeListener("disconnect", eventListeners.disconnect);
          }
          if (eventListeners.accountsChanged) {
            walletProvider.removeListener(
              "accountsChanged",
              eventListeners.accountsChanged
            );
          }
          if (eventListeners.chainChanged) {
            walletProvider.removeListener(
              "chainChanged",
              eventListeners.chainChanged
            );
          }
        }

        eventListeners = {};
        log("âœ… äº‹ä»¶ç›‘å¬å·²ç§»é™¤", "success");
      }

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          setActiveTab(btn.dataset.tab);
        });
      });
      setActiveTab("accounts");

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è¿æ¥çŠ¶æ€
      window.addEventListener("load", async () => {
        try {
          await waitForEthereum();
          log("âœ… YeYing Wallet å·²æ£€æµ‹åˆ°", "success");
          fillChainPreset("yeying");
          await testListenEvents();
          refreshDiagnostics();

          try {
            const accounts = await walletProvider.request({ method: "eth_accounts" });
            if (accounts.length > 0) {
              const chainId = await walletProvider.request({ method: "eth_chainId" });
              updateStatus("connected", accounts[0], chainId, true);
              log("âœ… è‡ªåŠ¨æ¢å¤è¿æ¥çŠ¶æ€", "success");
            } else {
              const emptyState = await resolveEmptyAccountsState(
                walletProvider,
                accounts
              );
              let chainId = null;
              if (emptyState.status === "locked") {
                try {
                  chainId = await walletProvider.request({
                    method: "eth_chainId",
                  });
                } catch (error) {
                  chainId = null;
                }
                log("ğŸ”’ æ£€æµ‹åˆ°é’±åŒ…å·²æˆæƒä½†å¤„äºé”å®šçŠ¶æ€", "info");
              }
              updateStatus(
                emptyState.status,
                null,
                chainId,
                emptyState.hasPermission
              );
            }
          } catch (error) {
            log("âš ï¸ æ— æ³•æ¢å¤è¿æ¥çŠ¶æ€");
          }
        } catch (error) {
          log("âŒ æœªæ£€æµ‹åˆ° YeYing Wallet", "error");
          walletProvider = undefined;
        }
      });
    </script>
  </body>
</html>
